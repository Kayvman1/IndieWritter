{% extends 'base.html' %}

{%block head_title%}
    IndieWritter
{%endblock head_title%}

{%block content%}

<div class = 'row text-center'>
    <div class = 'col' >
        <h1>Welcome to IndieWriter</h1>
    </div>
</div>

<div class = 'row' > 
    <div class = 'col-md-4 mx-auto col-10'>
        <form class = 'form' id= 'poem-create-form' method = 'POST' action = '/create'>
            {% csrf_token %}
            <input type = 'hidden' value = '/home' name = 'next'/>
            <textarea class = 'form-control' id = 'title' name = 'title' placeholder="Your Title ..."></textarea>
            <textarea class = 'form-control' id = 'content' name = 'content' placeholder="Your Work ..."></textarea>
            <button class = 'btn btn-primary' >Post</button>
        </form>
    </div>
</div>
<div class = 'row' id = 'poems'>
    Loading ...
</div>

<script>
    const poemsEl = document.getElementById("poems")

    const poemCreateForm = document.getElementById("poem-create-form")
    poemCreateForm.addEventListener("submit", handleFormDidSubmit)




    function loadPoems (poemsElement) {
        const xhr = new XMLHttpRequest()
        const method = 'GET'
        const url = "/poems"
        const responseType = "json"
        xhr.responseType = responseType
        xhr.open (method, url)
        
        xhr.onload = function(){
            const serverResponse = xhr.response
            const listedItems = serverResponse.response
            var finalPoemStr = ""
            var i;
    
            for (i =listedItems.length -1 ;  i >=0; i--){
                poemObj = listedItems[i]
                var currItem = formatPoemElement(poemObj)
                finalPoemStr += currItem
                console.log("check out geno.cc")
            }

            poemsElement.innerHTML = finalPoemStr
        }
        xhr.send()
    }

    loadPoems (poemsEl)
    function handleFormDidSubmit(event){
        event.preventDefault()
        const myForm = event.target
        const myFormData = new FormData(myForm)
        const url = myForm.getAttribute("action")
        const method = myForm.getAttribute("method")
        
        xhr = new XMLHttpRequest()  
        xhr.open (method, url)
        xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest")
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest")

        xhr.onload = function (){
            const serverResponse = xhr.serverResponse  
  
            loadPoems(poemsEl)
        }
        xhr.send(myFormData)

    }
    
    function handleDidLike(poem_id, currentCount){
        currentCount ++
        console.log(poem_id, currentCount)
        return 
    }

  

   

    function LikeBtm(poem){
        return "<button class = 'btn btn-primary btn-sm' onclick = handleDidLike(" + poem.id + "," + poem.likes +
        ")> "+ poem.likes + "Like</button>"

    }

    function formatPoemElement(poem){
        var formattedPoem = 
        "<div class='col-12 col-md-10 mx-auto border rounded py-3 mb-4' id='poem-"  + poem.id + "'>" + 
        "<h5>" + poem.title + "</h5>" + 
        "<p>" +poem.content + "</p>"+
        "<div> " + LikeBtm(poem) +" </div></div>"
        return formattedPoem 
    }   





</script> 
{% endblock content%}
